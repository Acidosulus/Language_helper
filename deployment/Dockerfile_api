FROM python:3.11-slim

# Prevent Python from writing .pyc files and enable unbuffered logs
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1

# Set workdir
WORKDIR /app/api

# System dependencies (lightweight). psycopg2-binary generally ships wheels.
# If you face build issues, uncomment the build tools below.
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl ca-certificates \
    && rm -rf /var/lib/apt/lists/*
# For potential source builds (only if needed):
# RUN apt-get update && apt-get install -y --no-install-recommends \
#     build-essential libffi-dev \
#     && rm -rf /var/lib/apt/lists/*

# Copy only dependency descriptors first for better layer caching
COPY api/pyproject.toml /app/api/pyproject.toml

# Install runtime Python dependencies
RUN python -m pip install --upgrade pip \
    && python - <<'PY'
import sys, subprocess
try:
    import tomllib  # Python 3.11+
except ModuleNotFoundError:  # Fallback if base image changes
    subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'tomli'])
    import tomli as tomllib

with open('pyproject.toml', 'rb') as f:
    data = tomllib.load(f)
deps = data.get('project', {}).get('dependencies', [])
if not deps:
    raise SystemExit('No [project].dependencies found in pyproject.toml')
subprocess.check_call([sys.executable, '-m', 'pip', 'install', '--no-cache-dir', *deps])
PY

# Copy the rest of the API source
COPY api/ /app/api/

# Expose application port
EXPOSE 8000

# Default command: run uvicorn without SSL (TLS should be terminated by a reverse proxy like nginx)
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
